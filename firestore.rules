rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== 헬퍼 함수 ====================

    // 인증된 사용자인지 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 본인인지 확인 (Google 인증된 교사)
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // ==================== 교사 프로필 ====================
    // /teachers/{uid} - 본인만 읽기/쓰기 가능
    match /teachers/{uid} {
      // 교사: 본인 프로필 읽기/쓰기
      allow read, write: if isOwner(uid);

      // ==================== 학급 (계층 구조) ====================
      // /teachers/{uid}/classes/{classId}
      match /classes/{classId} {
        // 교사: 본인 학급 모든 권한
        allow read, write: if isOwner(uid);

        // 학생 (익명 인증): 학급 정보 읽기만 가능
        allow read: if isAuthenticated();

        // ==================== 학급 하위 컬렉션 ====================

        // 학생 데이터: /teachers/{uid}/classes/{classId}/students/{studentId}
        match /students/{studentId} {
          // 교사: 모든 권한
          allow read, write: if isOwner(uid);

          // 학생 (익명 인증): 읽기 및 수정 가능 (펫 선택 시 petType 등 업데이트)
          allow read, update: if isAuthenticated();

          // ====== 학생 서브컬렉션 ======

          // 감정 기록: /teachers/{uid}/classes/{classId}/students/{studentId}/emotions/{emotionId}
          match /emotions/{emotionId} {
            // 교사: 모든 권한
            allow read, write: if isOwner(uid);

            // 학생 (익명 인증): 생성, 읽기, 수정 가능 (addStudentMessage, markReplyAsRead)
            allow create, read, update: if isAuthenticated();
          }

          // 칭찬 기록: /teachers/{uid}/classes/{classId}/students/{studentId}/praises/{praiseId}
          match /praises/{praiseId} {
            // 교사: 모든 권한
            allow read, write: if isOwner(uid);

            // 학생 (익명 인증): 읽기만 가능
            allow read: if isAuthenticated();
          }

          // 펫 데이터: /teachers/{uid}/classes/{classId}/students/{studentId}/pets/{petId}
          match /pets/{petId} {
            // 교사: 모든 권한
            allow read, write: if isOwner(uid);

            // 학생 (익명 인증): 생성, 읽기, 수정 가능 (addPetExp 경험치 업데이트)
            allow create, read, update: if isAuthenticated();
          }
        }

        // 시간표: /teachers/{uid}/classes/{classId}/timetable/{docId}
        match /timetable/{docId} {
          // 교사: 모든 권한
          allow read, write: if isOwner(uid);

          // 학생 (익명 인증): 읽기만 가능
          allow read: if isAuthenticated();
        }

        // 메모/노트: /teachers/{uid}/classes/{classId}/notes/{noteId}
        match /notes/{noteId} {
          // 교사만 접근 가능 (학생 접근 불가)
          allow read, write: if isOwner(uid);
        }
      }
    }

    // ==================== collectionGroup 쿼리용 규칙 ====================
    // cross-student 쿼리 시 교사 소유권 확인 (teacherUid 필드 기반)

    match /{path=**}/emotions/{emotionId} {
      allow read: if request.auth != null &&
                     resource.data.teacherUid == request.auth.uid;
    }

    match /{path=**}/praises/{praiseId} {
      allow read: if request.auth != null &&
                     resource.data.teacherUid == request.auth.uid;
    }

    // ==================== 학급 코드 매핑 ====================
    // /classCodes/{code} - 학생 접속용 (teacherUid + classId 매핑)
    match /classCodes/{code} {
      // 읽기: 인증된 모든 사용자 (학생이 학급코드로 접속할 때)
      allow read: if isAuthenticated();

      // 생성: 인증된 사용자 (학급 생성 시 - 교사)
      allow create: if isAuthenticated();

      // 수정/삭제: 해당 학급 소유자만 (계층 구조에서는 teacherUid로 확인)
      allow update, delete: if isAuthenticated() &&
                               resource.data.teacherUid == request.auth.uid;
    }
  }
}
